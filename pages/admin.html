<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›£æ‰¾çš„è¯è³½ - ç®¡ç†å¾Œå°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .login-container {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
        }

        .logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo h1 {
            color: #333;
            font-size: 28px;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .logo p {
            color: #666;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: bold;
        }

        .form-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
            background: #f8f9fa;
        }

        .form-group input:focus {
            outline: none;
            border-color: #dc3545;
            background: white;
            box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1);
        }

        .login-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #dc3545 0%, #b02a3a 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(220, 53, 69, 0.3);
        }

        .error-message {
            color: #e74c3c;
            text-align: center;
            margin-top: 15px;
            display: none;
            padding: 10px;
            background: #fdf2f2;
            border-radius: 5px;
        }

        .admin-dashboard {
            display: none;
            background: #f5f5f5;
            min-height: 100vh;
            width: 100%;
        }

        .admin-header {
            background: #dc3545;
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .admin-header h1 {
            font-size: 24px;
            font-weight: bold;
        }

        .logout-btn {
            background: #b02a3a;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.2s;
            font-weight: bold;
        }

        .logout-btn:hover {
            background: #8b1e2b;
        }

        .admin-content {
            padding: 30px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .game-selector {
            background: white;
            padding: 25px;
            border-radius: 5px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border: 1px solid #e0e0e0;
        }

        .game-selector h2 {
            margin-bottom: 20px;
            color: #333;
            font-size: 22px;
            font-weight: bold;
        }

        .game-select {
            width: 100%;
            max-width: 500px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            background: white;
            transition: all 0.3s;
        }

        .game-select:focus {
            outline: none;
            border-color: #dc3545;
            box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1);
        }

        .game-details {
            display: none;
            margin-top: 30px;
        }

        /* æ–°çš„éŠæˆ²ä½ˆå±€ */
        .game-board {
            background: white;
            border-radius: 5px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
        }

        .game-board-header {
            display: grid;
            grid-template-columns: 60px 4fr 4fr 80px 80px;
            gap: 0;
            background: #c44451;
            color: white;
            font-weight: bold;
            font-size: 16px;
        }

        .header-cell {
            padding: 20px 15px;
            text-align: center;
            border-right: 1px solid rgba(255,255,255,0.2);
        }

        .header-cell:last-child {
            border-right: none;
        }

        .game-board-body {
            background: white;
        }

        .game-row {
            display: grid;
            grid-template-columns: 60px 4fr 4fr 80px 80px;
            gap: 0;
            border-bottom: 1px solid #e0e0e0;
            transition: all 0.3s;
        }

        .game-row:hover {
            background: #f8f9fa;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .game-row:last-child {
            border-bottom: none;
        }

        .set-number {
            display: flex;
            align-items: center;
            justify-content: center;
            background: #c44451;
            color: white;
            font-weight: bold;
            font-size: 14px;
            border-right: 1px solid #e0e0e0;
        }

        .team-button {
            padding: 20px 15px;
            border: none;
            background: white;
            cursor: pointer;
            text-align: center;
            border-right: 1px solid #e0e0e0;
            transition: all 0.3s;
            position: relative;
        }

        .team-button:hover {
            background: #f0f7ff;
        }

        .team-button.selected {
            background: #495057;
            color: white;
        }

        .team-button.home-team.selected {
            background: #495057;
        }

        .team-button.away-team.selected {
            background: #495057;
        }

        .set-title {
            font-weight: bold;
            font-size: 14px;
            color: #333;
            margin-bottom: 4px;
        }

        .set-type {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }

        .player-info {
            font-size: 12px;
            color: #dc3545;
            font-weight: 500;
        }

        .team-button.selected .set-title,
        .team-button.selected .set-type,
        .team-button.selected .player-info {
            color: white;
        }

        .team-button.incomplete {
            background: #fff8dc;
            border-left: 4px solid #ffc107;
        }

        .team-button.incomplete .player-info {
            color: #e67e22;
            font-weight: bold;
        }

        .control-button {
            padding: 20px 15px;
            border: none;
            background: white;
            cursor: pointer;
            text-align: center;
            border-right: 1px solid #e0e0e0;
            transition: all 0.3s;
            font-size: 14px;
            font-weight: 500;
            color: #666;
        }

        .control-button:last-child {
            border-right: none;
        }

        .control-button:hover {
            background: #fdf2f2;
            color: #dc3545;
        }

        .control-button.home-selected {
            background: #dc3545;
            color: white;
            font-weight: bold;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(220, 53, 69, 0.3);
        }

        .control-button.away-selected {
            background: #f8a5aa;
            color: #721c24;
            font-weight: bold;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(248, 165, 170, 0.4);
        }

        /* é£²é…’åŠ æˆç°¡å–®ç‰ˆ */
        .bonus-simple {
            background: white;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border: 1px solid #e0e0e0;
            text-align: center;
        }

        .bonus-simple h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 16px;
            font-weight: bold;
        }

        .bonus-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .bonus-btn {
            padding: 12px 25px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            font-weight: 500;
            color: #333;
        }

        .bonus-btn:hover {
            border-color: #dc3545;
            color: #dc3545;
        }

        .bonus-btn.home-selected,
        .bonus-btn.away-selected {
            background: #dc3545;
            color: white;
            border-color: #dc3545;
        }

        /* åˆ†æ•¸è¨ˆç®—å€åŸŸ */
        .score-calculation {
            background: white;
            padding: 25px;
            border-radius: 5px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border: 1px solid #e0e0e0;
        }

        .score-calculation h3 {
            text-align: center;
            margin-bottom: 25px;
            color: #333;
            font-size: 22px;
            font-weight: bold;
        }

        .score-summary {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #e0e0e0;
        }

        .score-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
        }

        .team-info {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex: 1;
        }

        .team-name {
            font-size: 18px;
            font-weight: bold;
            padding: 8px 12px;
            border-radius: 5px;
            color: white;
            text-align: center;
        }

        .team-name.home-team {
            background: #dc3545;
        }

        .team-name.away-team {
            background: #c82333;
        }

        .score-detail {
            font-size: 14px;
            color: #666;
            background: white;
            padding: 6px 10px;
            border-radius: 3px;
        }

        .total-score {
            font-size: 16px;
            font-weight: bold;
            padding: 8px 12px;
            border-radius: 5px;
            text-align: center;
            color: white;
        }

        .total-score.home-total {
            background: #dc3545;
        }

        .total-score.away-total {
            background: #c82333;
        }

        .vs-divider {
            font-size: 20px;
            font-weight: bold;
            color: #666;
            padding: 0 20px;
        }

        /* ä¿å­˜æŒ‰éˆ• */
        .save-section {
            text-align: center;
            margin-top: 30px;
        }

        .save-btn {
            padding: 18px 50px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 8px 20px rgba(220, 53, 69, 0.3);
        }

        .save-btn:hover {
            background: #c82333;
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(220, 53, 69, 0.4);
        }

        .save-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* å½ˆçª—æ¨£å¼ */
        .player-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 450px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            margin-bottom: 25px;
            text-align: center;
        }

        .modal-header h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 20px;
            font-weight: bold;
        }

        .modal-header p {
            color: #666;
            font-size: 14px;
        }

        .player-list {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            max-height: 50vh;
            overflow-y: auto;
        }

        .player-option {
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            font-weight: 500;
        }

        .player-option:hover {
            border-color: #dc3545;
            background: #fdf2f2;
            transform: translateY(-2px);
        }

        .player-option.selected {
            background: #dc3545;
            color: white;
            border-color: #dc3545;
            transform: translateY(-2px);
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #999;
            transition: all 0.3s;
        }

        .close-modal:hover {
            color: #dc3545;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 16px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 1200px) {
            .game-board-header,
            .game-row {
                grid-template-columns: 50px 4fr 4fr 70px 70px;
            }
            
            .header-cell,
            .control-button {
                padding: 15px 6px;
                font-size: 12px;
            }
        }

        @media (max-width: 768px) {
            .admin-content {
                padding: 20px;
            }
            
            .game-board-header,
            .game-row {
                grid-template-columns: 40px 3fr 3fr 60px 60px;
            }
            
            .header-cell {
                padding: 12px 8px;
                font-size: 12px;
            }
            
            .team-button {
                padding: 15px 10px;
            }
            
            .set-title {
                font-size: 12px;
            }
            
            .set-type {
                font-size: 10px;
            }
            
            .player-info {
                font-size: 10px;
            }
            
            .control-button {
                padding: 15px 4px;
                font-size: 10px;
            }
            
            .score-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .score-row {
                flex-direction: row;
                gap: 10px;
                align-items: center;
            }

            .team-info {
                flex: 1;
                min-width: 0;
            }

            .team-name {
                font-size: 14px;
                padding: 6px 8px;
            }

            .score-detail {
                font-size: 12px;
                padding: 4px 6px;
            }

            .total-score {
                font-size: 14px;
                padding: 6px 8px;
            }

            .vs-divider {
                font-size: 16px;
                padding: 0 8px;
                flex-shrink: 0;
            }

            .bonus-buttons {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- ç™»å…¥é é¢ -->
    <div class="login-container" id="loginContainer">
        <div class="logo">
            <h1>é›£æ‰¾çš„è¯è³½</h1>
            <p>æ¯”è³½ç®¡ç†ç³»çµ±</p>
        </div>
        
        <form id="loginForm">
            <div class="form-group">
                <label for="username">å¸³è™Ÿ</label>
                <input type="text" id="username" name="username" required>
            </div>
            
            <div class="form-group">
                <label for="password">å¯†ç¢¼</label>
                <input type="password" id="password" name="password" required>
            </div>
            
            <button type="submit" class="login-btn">ç™»å…¥</button>
            
            <div class="error-message" id="errorMessage">
                å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤ï¼
            </div>
        </form>
    </div>

    <!-- ç®¡ç†å¾Œå° -->
    <div class="admin-dashboard" id="adminDashboard">
        <div class="admin-header">
            <h1>æ¯”è³½çµ±è¨ˆç³»çµ±</h1>
            <button class="logout-btn" onclick="logout()">ç™»å‡º</button>
        </div>
        
        <div class="admin-content">
            <div class="game-selector">
                <h2>é¸æ“‡æ¯”è³½</h2>
                <select class="game-select" id="gameSelect">
                    <option value="">è«‹é¸æ“‡æ¯”è³½...</option>
                </select>
                <div class="loading" id="loadingGames">è¼‰å…¥æ¯”è³½è³‡æ–™ä¸­...</div>
            </div>
            
            <div class="game-details" id="gameDetails">
                <!-- æ–°çš„éŠæˆ²ä½ˆå±€ -->
                <div class="game-board">
                    <div class="game-board-header">
                        <div class="header-cell">SET</div>
                        <div class="header-cell">ä¸»å ´</div>
                        <div class="header-cell">å®¢å ´</div>
                        <div class="header-cell">å…ˆæ”»</div>
                        <div class="header-cell">å‹è² </div>
                    </div>
                                         <div class="game-board-body">
                         <div id="gameRows">
                             <!-- SETè¡Œå°‡å‹•æ…‹ç”Ÿæˆ -->
                         </div>

                     </div>
                 </div>
                
                <!-- é£²é…’åŠ æˆ -->
                <div class="bonus-simple">
                    <h3>ğŸº é£²é…’åŠ æˆ (+5åˆ†)</h3>
                    <div class="bonus-buttons">
                        <button class="bonus-btn" data-team="home" onclick="selectBonus('home')" id="homeBonusBtn">
                            ä¸»å ´éšŠä¼
                        </button>
                        <button class="bonus-btn" data-team="away" onclick="selectBonus('away')" id="awayBonusBtn">
                            å®¢å ´éšŠä¼
                        </button>
                    </div>
                </div>
                
                <!-- æ¯”è³½æˆç¸¾è©¦ç®— -->
                <div class="score-calculation">
                    <h3>æ¯”è³½æˆç¸¾</h3>
                    <div class="score-summary">
                        <div class="score-row">
                            <div class="team-info">
                                <span class="team-name home-team" id="homeTeamScoreName">ä¸»å ´éšŠä¼</span>
                                <span class="score-detail">æ¯”è³½æˆç¸¾: <span id="homeOriginalScore">0</span></span>
                                <span class="score-detail">å‹æ–¹åŠ åˆ†: <span id="homeWinBonus">0</span></span>
                                <span class="score-detail">é£²é…’åŠ æˆ: <span id="homeDrinkBonus">0</span></span>
                                <span class="total-score home-total">ç¸½åˆ†: <span id="homeTotalScore">0</span></span>
                            </div>
                            <div class="vs-divider">VS</div>
                            <div class="team-info">
                                <span class="team-name away-team" id="awayTeamScoreName">å®¢å ´éšŠä¼</span>
                                <span class="score-detail">æ¯”è³½æˆç¸¾: <span id="awayOriginalScore">0</span></span>
                                <span class="score-detail">å‹æ–¹åŠ åˆ†: <span id="awayWinBonus">0</span></span>
                                <span class="score-detail">é£²é…’åŠ æˆ: <span id="awayDrinkBonus">0</span></span>
                                <span class="total-score away-total">ç¸½åˆ†: <span id="awayTotalScore">0</span></span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ä¿å­˜æŒ‰éˆ• -->
                <div class="save-section">
                    <button class="save-btn" id="saveBtn" onclick="saveGameData()">ä¿å­˜æ¯”è³½è³‡æ–™</button>
                </div>
            </div>
        </div>
    </div>

    <!-- é¸æ‰‹é¸æ“‡å½ˆçª— -->
    <div class="player-modal" id="playerModal">
        <div class="modal-content">
            <button class="close-modal" onclick="closePlayerModal()">&times;</button>
            <div class="modal-header">
                <h3 id="modalTitle">é¸æ“‡é¸æ‰‹</h3>
                <p id="modalSubtitle">SET1 - 501 (OI/MO)</p>
            </div>
            <div class="player-list" id="playerList">
                <!-- é¸æ‰‹åˆ—è¡¨å°‡å‹•æ…‹ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <!-- æ§åˆ¶é¸æ“‡å½ˆçª—ï¼ˆå…ˆæ”»/å‹è² ï¼‰ -->
    <div class="player-modal" id="controlModal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeControlModal()">&times;</button>
            <div class="modal-header">
                <h3 id="controlModalTitle">é¸æ“‡å…ˆæ”»</h3>
                <p id="controlModalSubtitle">SET1</p>
            </div>
            <div class="player-list">
                <div class="player-option" onclick="selectControl('home')" id="controlHomeOption">
                    ä¸»å ´
                </div>
                <div class="player-option" onclick="selectControl('away')" id="controlAwayOption">
                    å®¢å ´
                </div>
                <div class="player-option" onclick="selectControl(null)" id="controlNullOption">
                    ä¸é¸æ“‡
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let currentGame = null;
        let currentSet = null;
        let currentTeam = null;
        let currentControlType = null; // ç•¶å‰æ§åˆ¶é¡å‹ï¼ˆfirstAttack/winLoseï¼‰
        let playersData = {};
        let selectedPlayers = {}; // ç”¨æ–¼è¿½è¹¤é¸æ‰‹é¸æ“‡
        let firstAttackData = {}; // ç”¨æ–¼è¿½è¹¤å…ˆæ”»é¸æ“‡
        let winLoseData = {}; // ç”¨æ–¼è¿½è¹¤å‹è² é¸æ“‡
        let bonusTeam = null; // ç”¨æ–¼è¿½è¹¤é£²é…’åŠ æˆ
        let hasUnsavedChanges = false; // è¿½è¹¤æ˜¯å¦æœ‰æœªä¿å­˜çš„è®Šæ›´
        
        // é˜²éŒ¯æ©Ÿåˆ¶ - å®šç¾©ä¸èƒ½é‡è¤‡çš„SETçµ„åˆ
        const noRepeatGroups = [
            [1, 2, 3, 4],      // SET1-4 ä¸èƒ½é‡è¤‡
            [6, 7, 8, 9],      // SET6-9 ä¸èƒ½é‡è¤‡
            [11, 12],          // SET11-12 ä¸èƒ½é‡è¤‡
            [13, 14]           // SET13-14 ä¸èƒ½é‡è¤‡
        ];

        // æª¢æŸ¥æ˜¯å¦æœ‰æœªä¿å­˜çš„è³‡æ–™
        function hasAnyData() {
            // æª¢æŸ¥é¸æ‰‹é¸æ“‡
            for (let key in selectedPlayers) {
                if (selectedPlayers[key] && selectedPlayers[key].length > 0) {
                    return true;
                }
            }
            
            // æª¢æŸ¥å…ˆæ”»é¸æ“‡
            for (let key in firstAttackData) {
                if (firstAttackData[key]) {
                    return true;
                }
            }
            
            // æª¢æŸ¥å‹è² é¸æ“‡
            for (let key in winLoseData) {
                if (winLoseData[key]) {
                    return true;
                }
            }
            
            // æª¢æŸ¥é£²é…’åŠ æˆ
            if (bonusTeam) {
                return true;
            }
            
            return false;
        }

        // æ¨™è¨˜æœ‰è®Šæ›´
        function markAsChanged() {
            hasUnsavedChanges = true;
        }

        // æ¨™è¨˜å·²ä¿å­˜
        function markAsSaved() {
            hasUnsavedChanges = false;
        }
        
        // æ¯”è³½é …ç›®å®šç¾©
        const setTypes = {
            1: "501 (OI/MO)",
            2: "501 (DI/DO)", 
            3: "701 (OI/MO)",
            4: "701 (OI/MO, 25/50)",
            5: "ä¸‰äººè³½ 701",
            6: "Cricket",
            7: "Cricket",
            8: "Random Cricket",
            9: "Random Cricket", 
            10: "ä¸‰äººè³½ Cricket",
            11: "701 é›™äººè³½",
            12: "701 é›™äººè³½ FREEZE",
            13: "Cricket é›™äººè³½",
            14: "Team Cricket",
            15: "å››äººè³½ 1101",
            16: "å››äººè³½ Cricket"
        };

        // æ¯å€‹SETéœ€è¦çš„é¸æ‰‹æ•¸é‡
        const setPlayerCounts = {
            1: 1, 2: 1, 3: 1, 4: 1, 5: 3, 6: 1, 7: 1, 8: 1, 9: 1, 10: 3,
            11: 2, 12: 2, 13: 2, 14: 2, 15: 4, 16: 4
        };

        // ç™»å…¥è™•ç†
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (username === 'root' && password === 'root666') {
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('adminDashboard').style.display = 'block';
                loadGames();
                loadPlayers();
            } else {
                document.getElementById('errorMessage').style.display = 'block';
            }
        });

        // ç™»å‡º
        function logout() {
            document.getElementById('loginContainer').style.display = 'flex';
            document.getElementById('adminDashboard').style.display = 'none';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('errorMessage').style.display = 'none';
        }

        // å‹•æ…‹è¼‰å…¥æ¯”è³½è³‡æ–™
        async function loadGames() {
            try {
                document.getElementById('loadingGames').style.display = 'block';
                document.getElementById('loadingGames').textContent = 'è¼‰å…¥æ¯”è³½è³‡æ–™ä¸­...';
                
                // ç²å–ç•¶å‰æ—¥æœŸå’Œå‰å…©å¤©çš„æ—¥æœŸ
                const today = new Date();
                const dates = [];
                
                for (let i = 2; i >= 0; i--) {
                    const date = new Date(today);
                    date.setDate(today.getDate() - i);
                    dates.push(date);
                }
                
                console.log('æœå°‹æ—¥æœŸç¯„åœ:', dates.map(d => formatDate(d)));
                
                // å¾ Google Sheets è¼‰å…¥æ¯”è³½è³‡æ–™
                const games = await loadGamesFromSheet(dates);
                
                const select = document.getElementById('gameSelect');
                select.innerHTML = '<option value="">è«‹é¸æ“‡æ¯”è³½...</option>';
                
                if (games.length === 0) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'ç›®å‰æ²’æœ‰å¯ç”¨çš„æ¯”è³½';
                    option.disabled = true;
                    select.appendChild(option);
                } else {
                    // æŒ‰ gamecode æ•¸å­—æ’åºï¼ˆg41, g42, g43, g44...ï¼‰
                    games.sort((a, b) => {
                        // æå–æ•¸å­—éƒ¨åˆ†é€²è¡Œæ¯”è¼ƒ
                        const aNum = parseInt(a.id.replace(/\D/g, '')) || 0;
                        const bNum = parseInt(b.id.replace(/\D/g, '')) || 0;
                        return aNum - bNum;
                    });
                    
                    games.forEach(game => {
                        const option = document.createElement('option');
                        option.value = game.id;
                        option.textContent = `${game.id.toUpperCase()} (${game.date}) - ${game.away} vs ${game.home}`;
                        select.appendChild(option);
                    });
                }

                document.getElementById('loadingGames').style.display = 'none';
                
            } catch (error) {
                console.error('è¼‰å…¥æ¯”è³½è³‡æ–™å¤±æ•—:', error);
                document.getElementById('loadingGames').textContent = 'è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢';
            }
        }

        // æ ¼å¼åŒ–æ—¥æœŸç‚º M/D æ ¼å¼
        function formatDate(date) {
            return `${date.getMonth() + 1}/${date.getDate()}`;
        }

        // å¾ Google Sheets è¼‰å…¥æ¯”è³½è³‡æ–™
        async function loadGamesFromSheet(targetDates) {
            try {
                // ä½¿ç”¨æ–°çš„ API è¨­å®š
                const config = {
                    CLIENT_ID: '945502427007-dq3ldlv77r1u0h6me3s6jj948dajk6gm.apps.googleusercontent.com',
                    API_KEY: 'AIzaSyDtba1arudetdcnc3yd3ri7Q35HlAndjr0',
                    SCHEDULE_SHEET_ID: '1UV-uMGibCmqPqhlMCqmNH2Z_fBQQTJQcqTGjkBQNiOE', // è®€å–æ¯”è³½å ´æ¬¡
                    RESULT_SHEET_ID: '1V2hj-9R-C2GWYu6Wo-por-gNvm56vGFPjx4ELcx3XtE'    // å¯«å…¥æ¯”è³½çµæœ
                };
                
                const range = 'schedule!A:H'; // è®€å–Aåˆ°Hæ¬„ï¼Œç¢ºä¿åŒ…å«æ‰€æœ‰å¿…è¦è³‡æ–™
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${config.SCHEDULE_SHEET_ID}/values/${range}?key=${config.API_KEY}`;
                
                console.log('è¼‰å…¥æ¯”è³½è³‡æ–™ URL:', url);
                
                const response = await fetch(url);
                if (!response.ok) {
                    console.error('API å›æ‡‰éŒ¯èª¤:', response.status, response.statusText);
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (!data.values || data.values.length === 0) {
                    console.log('æ²’æœ‰æ‰¾åˆ°æ¯”è³½è³‡æ–™');
                    return getStaticGames(targetDates);
                }
                
                // è§£ææ¯”è³½è³‡æ–™
                const games = [];
                const targetDateStrings = targetDates.map(date => formatDate(date));
                
                console.log('ç›®æ¨™æ—¥æœŸ:', targetDateStrings);
                console.log('Google Sheets åŸå§‹è³‡æ–™:', data.values);
                
                // å¾ç¬¬äºŒè¡Œé–‹å§‹ï¼ˆè·³éæ¨™é¡Œè¡Œï¼‰
                for (let i = 1; i < data.values.length; i++) {
                    const row = data.values[i];
                    
                    // æ ¹æ“šå¯¦éš›è¡¨æ ¼æ ¼å¼ï¼šA=æ¯”è³½ID, B=æ—¥æœŸ, C=å®¢éšŠ, D=å®¢å ´åˆ†æ•¸, E=vs, F=ä¸»å ´åˆ†æ•¸, G=ä¸»éšŠ
                    if (row.length >= 7) {
                        const gameId = row[0];    // Aæ¬„ï¼šæ¯”è³½ID (G01, G02...)
                        const gameDate = row[1];  // Bæ¬„ï¼šæ—¥æœŸ (4/8, 4/15...)
                        const awayTeam = row[2];  // Cæ¬„ï¼šå®¢éšŠ
                        const homeTeam = row[6];  // Gæ¬„ï¼šä¸»éšŠ
                        
                        // æª¢æŸ¥å¿…è¦æ¬„ä½æ˜¯å¦å­˜åœ¨ä¸”æ—¥æœŸåœ¨ç›®æ¨™ç¯„åœå…§
                        if (gameDate && gameId && awayTeam && homeTeam && targetDateStrings.includes(gameDate)) {
                            games.push({
                                id: gameId,
                                date: gameDate,
                                dateObj: parseGameDate(gameDate),
                                away: awayTeam,
                                home: homeTeam
                            });
                        }
                    }
                }
                
                console.log('å¾ Google Sheets è¼‰å…¥çš„æ¯”è³½:', games);
                return games.length > 0 ? games : getStaticGames(targetDates);
                
            } catch (error) {
                console.error('å¾ Google Sheets è¼‰å…¥æ¯”è³½è³‡æ–™å¤±æ•—:', error);
                console.log('ä½¿ç”¨å‚™ç”¨éœæ…‹è³‡æ–™');
                return getStaticGames(targetDates);
            }
        }

        // è§£ææ¯”è³½æ—¥æœŸ
        function parseGameDate(dateString) {
            const parts = dateString.split('/');
            if (parts.length === 2) {
                const month = parseInt(parts[0]) - 1; // JavaScript æœˆä»½å¾ 0 é–‹å§‹
                const day = parseInt(parts[1]);
                const year = new Date().getFullYear(); // å‡è¨­æ˜¯ç•¶å¹´
                return new Date(year, month, day);
            }
            return new Date();
        }

        // å‚™ç”¨éœæ…‹æ¯”è³½è³‡æ–™
        function getStaticGames(targetDates) {
            const today = new Date();
            const todayString = formatDate(today);
            
            const allGames = [
                // æœ€æ–°æ¯”è³½ï¼ˆä½¿ç”¨ä»Šå¤©æ—¥æœŸï¼‰
                { id: 'g48', date: todayString, away: 'é€ƒç”Ÿå…¥å£A', home: 'Viviæœé…’æ™šèˆ' },
                { id: 'g47', date: todayString, away: 'æµ·ç›œæªç¡¬', home: 'äººç”Ÿæªé›£' },
                { id: 'g46', date: todayString, away: 'é…’ç©ºçµ„', home: 'Jack' },
                { id: 'g45', date: todayString, away: 'ä¸€é¢é–‹å¤©é–€', home: 'é€ƒç”Ÿå…¥å£C' },
                
                // æ˜¨å¤©çš„æ¯”è³½
                { id: 'g44', date: '6/17', away: 'é€ƒç”Ÿå…¥å£C', home: 'Jack' },
                { id: 'g43', date: '6/17', away: 'Viviæœé…’æ™šèˆ', home: 'äººç”Ÿæªé›£' },
                { id: 'g42', date: '6/17', away: 'æµ·ç›œæªç¡¬', home: 'é…’ç©ºçµ„' },
                { id: 'g41', date: '6/17', away: 'é€ƒç”Ÿå…¥å£A', home: 'ä¸€é¢é–‹å¤©é–€' },
                
                // å‰å¤©çš„æ¯”è³½
                { id: 'g40', date: '6/16', away: 'æµ·ç›œæªç¡¬', home: 'ä¸€é¢é–‹å¤©é–€' },
                { id: 'g39', date: '6/16', away: 'Viviæœé…’æ™šèˆ', home: 'é€ƒç”Ÿå…¥å£C' },
                { id: 'g38', date: '6/16', away: 'Jack', home: 'é…’ç©ºçµ„' },
                { id: 'g37', date: '6/16', away: 'äººç”Ÿæªé›£', home: 'é€ƒç”Ÿå…¥å£A' },
            ];
            
            const targetDateStrings = targetDates.map(date => formatDate(date));
            
            return allGames.filter(game => targetDateStrings.includes(game.date))
                          .map(game => ({
                              ...game,
                              dateObj: parseGameDate(game.date)
                          }))
                          .sort((a, b) => {
                              // æŒ‰ gamecode æ•¸å­—æ’åº
                              const aNum = parseInt(a.id.replace(/\D/g, '')) || 0;
                              const bNum = parseInt(b.id.replace(/\D/g, '')) || 0;
                              return aNum - bNum;
                          });
        }

        // è¼‰å…¥é¸æ‰‹è³‡æ–™
        async function loadPlayers() {
            try {
                const response = await fetch('../data/player.json');
                playersData = await response.json();
                console.log('é¸æ‰‹è³‡æ–™è¼‰å…¥æˆåŠŸ:', playersData);
            } catch (error) {
                console.error('è¼‰å…¥é¸æ‰‹è³‡æ–™å¤±æ•—:', error);
                alert('è¼‰å…¥é¸æ‰‹è³‡æ–™å¤±æ•—ï¼Œè«‹æª¢æŸ¥ player.json æ–‡ä»¶');
            }
        }

        // ç”¨æ–¼å„²å­˜ç•¶å‰é¸æ“‡çš„æ¯”è³½ID
        let currentGameId = null;

        // æ¯”è³½é¸æ“‡è™•ç†
        document.getElementById('gameSelect').addEventListener('change', function(e) {
            const newGameId = e.target.value;
            
            // å¦‚æœæœ‰æœªä¿å­˜çš„è³‡æ–™ä¸”åˆ‡æ›åˆ°ä¸åŒæ¯”è³½ï¼Œé¡¯ç¤ºè­¦å‘Š
            if (currentGame && hasAnyData() && hasUnsavedChanges && newGameId !== currentGameId) {
                const confirmLeave = confirm('âš ï¸ è­¦å‘Šï¼\n\næ‚¨æœ‰æœªä¿å­˜çš„æ¯”è³½è³‡æ–™ï¼Œå¦‚æœé›¢é–‹å°‡æœƒéºå¤±æ‰€æœ‰å·²å¡«å¯«çš„å…§å®¹ã€‚\n\nç¢ºèªè¦é›¢é–‹ç•¶å‰æ¯”è³½å—ï¼Ÿ');
                
                if (!confirmLeave) {
                    // ç”¨æˆ¶é¸æ“‡å–æ¶ˆï¼Œæ¢å¾©åŸä¾†çš„é¸æ“‡
                    setTimeout(() => {
                        e.target.value = currentGameId || '';
                    }, 0);
                    return;
                }
            }
            
            if (newGameId) {
                currentGameId = newGameId; // æ›´æ–°ç•¶å‰æ¯”è³½ID
                loadGameDetails(newGameId);
            } else {
                if (currentGame && hasAnyData() && hasUnsavedChanges) {
                    const confirmLeave = confirm('âš ï¸ è­¦å‘Šï¼\n\næ‚¨æœ‰æœªä¿å­˜çš„æ¯”è³½è³‡æ–™ï¼Œå¦‚æœé›¢é–‹å°‡æœƒéºå¤±æ‰€æœ‰å·²å¡«å¯«çš„å…§å®¹ã€‚\n\nç¢ºèªè¦å–æ¶ˆé¸æ“‡æ¯”è³½å—ï¼Ÿ');
                    
                    if (!confirmLeave) {
                        setTimeout(() => {
                            e.target.value = currentGameId || '';
                        }, 0);
                        return;
                    }
                }
                document.getElementById('gameDetails').style.display = 'none';
                currentGame = null;
                currentGameId = null;
                hasUnsavedChanges = false;
            }
        });

        // è¼‰å…¥æ¯”è³½è©³æƒ…
        function loadGameDetails(gameId) {
            // å¾ä¸‹æ‹‰é¸å–®ä¸­ç²å–æ¯”è³½è³‡æ–™
            const select = document.getElementById('gameSelect');
            const selectedOption = Array.from(select.options).find(option => option.value === gameId);
            
            if (!selectedOption) {
                console.error('æ‰¾ä¸åˆ°æ¯”è³½è³‡æ–™:', gameId);
                return;
            }
            
            // è§£æé¸é …æ–‡å­—ä»¥ç²å–éšŠä¼åç¨±
            // æ ¼å¼: "G44 (6/17) - é€ƒç”Ÿå…¥å£C vs Jack"
            const optionText = selectedOption.textContent;
            const match = optionText.match(/^.+?\s-\s(.+?)\svs\s(.+)$/);
            
            if (match) {
                currentGame = {
                    away: match[1].trim(),
                    home: match[2].trim()
                };
            } else {
                console.error('ç„¡æ³•è§£ææ¯”è³½è³‡æ–™:', optionText);
                return;
            }

            // é‡ç½®æ‰€æœ‰æ•¸æ“š
            selectedPlayers = {};
            firstAttackData = {};
            winLoseData = {};
            bonusTeam = null;
            hasUnsavedChanges = false;

            // æ›´æ–°éšŠä¼åç¨±
            document.getElementById('homeTeamScoreName').textContent = currentGame.home;
            document.getElementById('awayTeamScoreName').textContent = currentGame.away;
            document.getElementById('homeBonusBtn').textContent = currentGame.home;
            document.getElementById('awayBonusBtn').textContent = currentGame.away;

            // ç”Ÿæˆä½ˆå±€
            generateGameLayout();

            // é‡ç½®é£²é…’åŠ æˆ
            document.querySelectorAll('.bonus-button').forEach(btn => {
                btn.classList.remove('home-selected', 'away-selected');
            });

            // æ›´æ–°è©¦ç®—
            updateScoreCalculation();

            // åˆå§‹åŒ–æ‰€æœ‰SETæŒ‰éˆ•çš„é¡¯ç¤ºç‹€æ…‹
            updateAllSetButtons();

            document.getElementById('gameDetails').style.display = 'block';
        }

        // é¸æ“‡é£²é…’åŠ æˆ
        function selectBonus(team) {
            // æ¸…é™¤æ‰€æœ‰é¸æ“‡
            document.querySelectorAll('.bonus-btn').forEach(btn => {
                btn.classList.remove('home-selected', 'away-selected');
            });
            
            if (bonusTeam === team) {
                // å¦‚æœé»æ“Šçš„æ˜¯å·²é¸æ“‡çš„ï¼Œå‰‡å–æ¶ˆé¸æ“‡
                bonusTeam = null;
            } else {
                // é¸æ“‡æ–°çš„éšŠä¼
                bonusTeam = team;
                const button = document.querySelector(`[data-team="${team}"]`);
                button.classList.add(team === 'home' ? 'home-selected' : 'away-selected');
            }
            
            // æ¨™è¨˜æœ‰è®Šæ›´
            markAsChanged();
            
            // æ›´æ–°è©¦ç®—
            updateScoreCalculation();
        }

        // é–‹å•Ÿé¸æ‰‹é¸æ“‡å½ˆçª—
        function openPlayerModal(setNumber, team) {
            currentSet = setNumber;
            currentTeam = team;
            
            const teamName = team === 'home' ? currentGame.home : currentGame.away;
            const players = playersData[teamName] || [];
            const requiredPlayers = setPlayerCounts[setNumber];
            
            // åˆå§‹åŒ–é¸ä¸­çš„é¸æ‰‹
            const key = `${currentTeam}-${currentSet}`;
            if (!selectedPlayers[key]) {
                selectedPlayers[key] = [];
            }
            
            document.getElementById('modalTitle').textContent = `é¸æ“‡é¸æ‰‹ - ${teamName}`;
            document.getElementById('modalSubtitle').textContent = `SET${setNumber} - ${setTypes[setNumber]} (éœ€é¸æ“‡${requiredPlayers}äºº)`;
            
            const playerList = document.getElementById('playerList');
            playerList.innerHTML = '';
            
            players.forEach(player => {
                const playerDiv = document.createElement('div');
                playerDiv.className = 'player-option';
                playerDiv.textContent = player;
                
                // æª¢æŸ¥æ˜¯å¦å·²é¸ä¸­
                if (selectedPlayers[key].includes(player)) {
                    playerDiv.classList.add('selected');
                }
                
                playerDiv.addEventListener('click', () => togglePlayerSelection(player, requiredPlayers));
                playerList.appendChild(playerDiv);
            });
            
            document.getElementById('playerModal').style.display = 'block';
        }

        // æª¢æŸ¥é¸æ‰‹æ˜¯å¦åœ¨åŒçµ„SETä¸­é‡è¤‡
        function checkPlayerConflict(playerName, setNumber, teamType) {
            for (const group of noRepeatGroups) {
                if (group.includes(setNumber)) {
                    // æª¢æŸ¥åŒçµ„å…¶ä»–SETæ˜¯å¦å·²æœ‰æ­¤é¸æ‰‹
                    for (const otherSet of group) {
                        if (otherSet !== setNumber) {
                            const otherKey = `${teamType}-${otherSet}`;
                            if (selectedPlayers[otherKey] && selectedPlayers[otherKey].includes(playerName)) {
                                return `${playerName} å·²åœ¨ SET${otherSet} ä¸­å‡ºå ´ï¼ŒåŒçµ„SETä¸èƒ½é‡è¤‡é¸æ“‡ï¼`;
                            }
                        }
                    }
                    break;
                }
            }
            return null;
        }

        // åˆ‡æ›é¸æ‰‹é¸æ“‡ç‹€æ…‹
        function togglePlayerSelection(playerName, requiredPlayers) {
            const key = `${currentTeam}-${currentSet}`;
            const playerIndex = selectedPlayers[key].indexOf(playerName);
            
            if (playerIndex > -1) {
                // å–æ¶ˆé¸æ“‡
                selectedPlayers[key].splice(playerIndex, 1);
            } else {
                // æª¢æŸ¥æ˜¯å¦æœƒé€ æˆé‡è¤‡
                const conflictMessage = checkPlayerConflict(playerName, currentSet, currentTeam);
                if (conflictMessage) {
                    alert(conflictMessage);
                    return;
                }
                
                // æ–°å¢é¸æ“‡
                if (selectedPlayers[key].length < requiredPlayers) {
                    selectedPlayers[key].push(playerName);
                } else {
                    alert(`æœ€å¤šåªèƒ½é¸æ“‡${requiredPlayers}ä½é¸æ‰‹ï¼`);
                    return;
                }
            }
            
            // æ›´æ–°UI
            const playerOptions = document.querySelectorAll('.player-option');
            playerOptions.forEach(option => {
                if (option.textContent === playerName) {
                    option.classList.toggle('selected');
                }
            });
            
            // å³æ™‚æ›´æ–°SETæŒ‰éˆ•
            updateSetButton();
            
            // æ¨™è¨˜æœ‰è®Šæ›´
            markAsChanged();
            
            // å¦‚æœé¸æ»¿äº†æŒ‡å®šäººæ•¸ï¼Œç«‹å³é—œé–‰å½ˆçª—
            if (selectedPlayers[key].length === requiredPlayers) {
                closePlayerModal();
            }
        }

        // æ›´æ–°SETæŒ‰éˆ•é¡¯ç¤º
        function updateSetButton() {
            const key = `${currentTeam}-${currentSet}`;
            const playerElement = document.getElementById(`${currentTeam}-set${currentSet}-player`);
            const buttonElement = document.querySelector(`[data-set="${currentSet}"][data-team="${currentTeam}"]`);
            const requiredPlayers = setPlayerCounts[currentSet];
            const selectedCount = selectedPlayers[key] ? selectedPlayers[key].length : 0;
            
            if (selectedCount > 0) {
                if (selectedCount === requiredPlayers) {
                    // é¸æ»¿äººæ•¸ - è®Šæˆç°è‰²ï¼ˆå·²å®Œæˆï¼‰
                    playerElement.textContent = `âœ“ å·²é¸æ“‡: ${selectedPlayers[key].join(', ')}`;
                    buttonElement.classList.add('selected');
                    buttonElement.classList.remove('incomplete');
                } else {
                    // äººæ•¸ä¸è¶³ - ä¿æŒç™½è‰²ï¼Œä½†é¡¯ç¤ºé€²åº¦
                    playerElement.textContent = `âš  å·²é¸æ“‡ ${selectedCount}/${requiredPlayers}: ${selectedPlayers[key].join(', ')}`;
                    buttonElement.classList.remove('selected');
                    buttonElement.classList.add('incomplete');
                }
            } else {
                // å°šæœªé¸æ“‡ - ç™½è‰²èƒŒæ™¯
                if (requiredPlayers > 1) {
                    playerElement.textContent = `é»æ“Šé¸æ“‡é¸æ‰‹ (éœ€${requiredPlayers}äºº)`;
                } else {
                    playerElement.textContent = 'é»æ“Šé¸æ“‡é¸æ‰‹';
                }
                buttonElement.classList.remove('selected', 'incomplete');
            }
            
            // æ›´æ–°è©¦ç®—
            updateScoreCalculation();
        }

        // æ›´æ–°æ‰€æœ‰SETæŒ‰éˆ•çš„é¡¯ç¤ºç‹€æ…‹
        function updateAllSetButtons() {
            for (let i = 1; i <= 16; i++) {
                ['home', 'away'].forEach(team => {
                    const key = `${team}-${i}`;
                    const playerElement = document.getElementById(`${team}-set${i}-player`);
                    const buttonElement = document.querySelector(`[data-set="${i}"][data-team="${team}"]`);
                    const requiredPlayers = setPlayerCounts[i];
                    const selectedCount = selectedPlayers[key] ? selectedPlayers[key].length : 0;
                    
                    if (selectedCount > 0) {
                        if (selectedCount === requiredPlayers) {
                            // é¸æ»¿äººæ•¸ - è®Šæˆç°è‰²ï¼ˆå·²å®Œæˆï¼‰
                            playerElement.textContent = `âœ“ å·²é¸æ“‡: ${selectedPlayers[key].join(', ')}`;
                            buttonElement.classList.add('selected');
                            buttonElement.classList.remove('incomplete');
                        } else {
                            // äººæ•¸ä¸è¶³ - é»ƒè‰²èƒŒæ™¯ï¼Œé¡¯ç¤ºé€²åº¦
                            playerElement.textContent = `âš  å·²é¸æ“‡ ${selectedCount}/${requiredPlayers}: ${selectedPlayers[key].join(', ')}`;
                            buttonElement.classList.remove('selected');
                            buttonElement.classList.add('incomplete');
                        }
                    } else {
                        // å°šæœªé¸æ“‡ - ç™½è‰²èƒŒæ™¯
                        if (requiredPlayers > 1) {
                            playerElement.textContent = `é»æ“Šé¸æ“‡é¸æ‰‹ (éœ€${requiredPlayers}äºº)`;
                        } else {
                            playerElement.textContent = 'é»æ“Šé¸æ“‡é¸æ‰‹';
                        }
                        buttonElement.classList.remove('selected', 'incomplete');
                    }
                });
            }
        }

        // æ›´æ–°æ¯”è³½æˆç¸¾è©¦ç®—
        function updateScoreCalculation() {
            let homeScore = 0;
            let awayScore = 0;
            
            // è¨ˆç®—åŸå§‹åˆ†æ•¸ - æ ¹æ“šå‹è² ä¾†è¨ˆåˆ†
            for (let i = 1; i <= 16; i++) {
                const requiredPlayers = setPlayerCounts[i];
                const winner = winLoseData[i]; // 'home' æˆ– 'away'
                
                // åªæœ‰ç•¶è©²SETæœ‰å‹è² çµæœæ™‚æ‰è¨ˆåˆ†
                if (winner === 'home') {
                    homeScore += requiredPlayers;
                } else if (winner === 'away') {
                    awayScore += requiredPlayers;
                }
                // å¦‚æœæ²’æœ‰å‹è² çµæœï¼Œå‰‡ä¸åŠ åˆ†
            }
            
            // å‹å ´åŠ æˆï¼ˆåŸå§‹åˆ†æ•¸è¼ƒé«˜çš„+1ï¼‰
            let homeWinBonus = 0;
            let awayWinBonus = 0;
            if (homeScore > awayScore) {
                homeWinBonus = 1;
            } else if (awayScore > homeScore) {
                awayWinBonus = 1;
            }
            
            // é£²é…’åŠ æˆ
            let homeDrinkBonus = 0;
            let awayDrinkBonus = 0;
            if (bonusTeam === 'home') {
                homeDrinkBonus = 5;
            } else if (bonusTeam === 'away') {
                awayDrinkBonus = 5;
            }
            
            // æ›´æ–°é¡¯ç¤º
            document.getElementById('homeOriginalScore').textContent = homeScore;
            document.getElementById('homeWinBonus').textContent = homeWinBonus;
            document.getElementById('homeDrinkBonus').textContent = homeDrinkBonus;
            document.getElementById('homeTotalScore').textContent = homeScore + homeWinBonus + homeDrinkBonus;
            
            document.getElementById('awayOriginalScore').textContent = awayScore;
            document.getElementById('awayWinBonus').textContent = awayWinBonus;
            document.getElementById('awayDrinkBonus').textContent = awayDrinkBonus;
            document.getElementById('awayTotalScore').textContent = awayScore + awayWinBonus + awayDrinkBonus;
        }

        // æª¢æŸ¥è³‡æ–™å®Œæ•´æ€§
        function validateGameData() {
            const missingData = [];
            
            // æª¢æŸ¥æ‰€æœ‰SETçš„é¸æ‰‹é¸æ“‡
            for (let i = 1; i <= 16; i++) {
                const homeKey = `home-${i}`;
                const awayKey = `away-${i}`;
                const requiredPlayers = setPlayerCounts[i];
                
                if (!selectedPlayers[homeKey] || selectedPlayers[homeKey].length !== requiredPlayers) {
                    missingData.push(`SET${i} ä¸»å ´é¸æ‰‹`);
                }
                if (!selectedPlayers[awayKey] || selectedPlayers[awayKey].length !== requiredPlayers) {
                    missingData.push(`SET${i} å®¢å ´é¸æ‰‹`);
                }
            }
            
            // æª¢æŸ¥å…ˆæ”»é¸æ“‡
            for (let i = 1; i <= 16; i++) {
                if (!firstAttackData[i]) {
                    missingData.push(`SET${i} å…ˆæ”»`);
                }
            }
            
            // æª¢æŸ¥å‹è² é¸æ“‡
            for (let i = 1; i <= 16; i++) {
                if (!winLoseData[i]) {
                    missingData.push(`SET${i} å‹è² `);
                }
            }
            
            return missingData;
        }

        // ä¿å­˜æ¯”è³½è³‡æ–™
        function saveGameData() {
            // æª¢æŸ¥æ˜¯å¦æœ‰é¸æ“‡æ¯”è³½
            if (!currentGame) {
                alert('è«‹å…ˆé¸æ“‡æ¯”è³½ï¼');
                return;
            }
            
            // æª¢æŸ¥è³‡æ–™å®Œæ•´æ€§
            const missingData = validateGameData();
            if (missingData.length > 0) {
                alert(`ä»¥ä¸‹å ´æ¬¡å°šæœªç™»è¨˜å®Œæˆï¼š\n\n${missingData.join('\n')}\n\nè«‹å…ˆå®Œæˆæ‰€æœ‰æ¬„ä½çš„å¡«å¯«ã€‚`);
                return;
            }
            
            // æº–å‚™ä¿å­˜çš„è³‡æ–™
            const gameData = {
                gameId: document.getElementById('gameSelect').value,
                homeTeam: currentGame.home,
                awayTeam: currentGame.away,
                selectedPlayers: selectedPlayers,
                firstAttackData: firstAttackData,
                winLoseData: winLoseData,
                bonusTeam: bonusTeam,
                scores: {
                    home: {
                        original: parseInt(document.getElementById('homeOriginalScore').textContent),
                        winBonus: parseInt(document.getElementById('homeWinBonus').textContent),
                        drinkBonus: parseInt(document.getElementById('homeDrinkBonus').textContent),
                        total: parseInt(document.getElementById('homeTotalScore').textContent)
                    },
                    away: {
                        original: parseInt(document.getElementById('awayOriginalScore').textContent),
                        winBonus: parseInt(document.getElementById('awayWinBonus').textContent),
                        drinkBonus: parseInt(document.getElementById('awayDrinkBonus').textContent),
                        total: parseInt(document.getElementById('awayTotalScore').textContent)
                    }
                },
                timestamp: new Date().toISOString()
            };
            
            // ç¢ºèªå°è©±æ¡† - é¡¯ç¤ºæ¯”åˆ†
            const confirmMessage = `è«‹ç¢ºèªæ¯”è³½çµæœï¼š\n\næ¯”è³½ï¼š${gameData.gameId.toUpperCase()}\n\n${gameData.homeTeam}ï¼š${gameData.scores.home.total} åˆ†\n${gameData.awayTeam}ï¼š${gameData.scores.away.total} åˆ†\n\nç¢ºèªç„¡èª¤å¾Œå°‡å¯«å…¥`;
            
            if (confirm(confirmMessage)) {
                saveToGoogleSheets(gameData);
            }
        }

        // ä¿å­˜åˆ° Google Sheets
        async function saveToGoogleSheets(gameData) {
            const saveBtn = document.getElementById('saveBtn');
            const originalText = saveBtn.textContent;
            
            try {
                // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
                saveBtn.textContent = 'ä¿å­˜ä¸­...';
                saveBtn.disabled = true;
                
                console.log('æº–å‚™ä¿å­˜è³‡æ–™ï¼š', gameData);
                
                // Google Apps Script Web App URL
                const scriptURL = 'https://script.google.com/macros/s/AKfycbyvqowohZQJ1Prh9Zgo4M9JM01PQKyGtpPfEY0gw6CBc41zq6BcLnKixM7yo4uKnILt/exec';
                
                console.log('ç™¼é€è«‹æ±‚åˆ°ï¼š', scriptURL);
                
                const response = await fetch(scriptURL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'text/plain', // æ”¹ç‚º text/plain é¿å… CORS é æª¢
                    },
                    body: JSON.stringify(gameData)
                });
                
                console.log('æ”¶åˆ°å›æ‡‰ï¼š', response.status, response.statusText);
                
                if (response.ok) {
                    const resultText = await response.text();
                    console.log('å›æ‡‰å…§å®¹ï¼š', resultText);
                    
                    try {
                        const result = JSON.parse(resultText);
                        if (result.status === 'success') {
                            markAsSaved();
                            alert(`âœ… æ¯”è³½è³‡æ–™å·²æˆåŠŸä¿å­˜ï¼\n\næ¯”è³½ï¼š${result.gameId}\næ™‚é–“ï¼š${new Date(result.timestamp).toLocaleString()}\n\né é¢å°‡è‡ªå‹•é—œé–‰...`);
                            console.log('ä¿å­˜æˆåŠŸï¼š', result);
                            
                            // å»¶é² 1 ç§’å¾Œé—œé–‰åˆ†é 
                            setTimeout(() => {
                                window.close();
                            }, 1000);
                        } else {
                            throw new Error(result.message || 'ä¿å­˜å¤±æ•—');
                        }
                    } catch (parseError) {
                        console.error('è§£æå›æ‡‰å¤±æ•—ï¼š', parseError);
                        // å¦‚æœç„¡æ³•è§£æ JSONï¼Œä½†ç‹€æ…‹ç¢¼æ˜¯ 200ï¼Œå¯èƒ½é‚„æ˜¯æˆåŠŸäº†
                        if (resultText.includes('success') || resultText.includes('æˆåŠŸ') || resultText.includes('"status":"success"')) {
                            markAsSaved();
                            alert('âœ… æ¯”è³½è³‡æ–™å·²ä¿å­˜å®Œæˆï¼\n\né é¢å°‡è‡ªå‹•é—œé–‰...');
                            
                            // å»¶é² 1 ç§’å¾Œé—œé–‰åˆ†é 
                            setTimeout(() => {
                                window.close();
                            }, 1000);
                        } else {
                            throw new Error('ä¼ºæœå™¨å›æ‡‰æ ¼å¼éŒ¯èª¤ï¼š' + resultText.substring(0, 100));
                        }
                    }
                } else {
                    const errorText = await response.text();
                    console.error('HTTP éŒ¯èª¤ï¼š', response.status, errorText);
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
            } catch (error) {
                console.error('ä¿å­˜åˆ° Google Sheets å¤±æ•—ï¼š', error);
                
                let errorMessage = 'ä¿å­˜å¤±æ•—ï¼';
                if (error.message.includes('Failed to fetch') || error.message.includes('Load failed')) {
                    errorMessage += '\n\nå¯èƒ½åŸå› ï¼š\n1. ç¶²è·¯é€£ç·šå•é¡Œ\n2. Google Apps Script æœªæ­£ç¢ºéƒ¨ç½²\n3. è·¨åŸŸè«‹æ±‚è¢«é˜»æ“‹';
                } else {
                    errorMessage += '\n\néŒ¯èª¤è³‡è¨Šï¼š' + error.message;
                }
                
                alert(errorMessage);
                
                // é™ç´šä¿å­˜åˆ°æœ¬åœ°å­˜å„²
                if (confirm('æ˜¯å¦æ”¹ç‚ºä¿å­˜åˆ°æœ¬åœ°å­˜å„²ï¼Ÿ')) {
                    saveToLocalStorage(gameData);
                }
            } finally {
                // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                saveBtn.textContent = originalText;
                saveBtn.disabled = false;
            }
        }

        // ä¿å­˜åˆ°æœ¬åœ°å­˜å„²ï¼ˆå‚™ç”¨æ–¹æ¡ˆï¼‰
        function saveToLocalStorage(gameData) {
            try {
                const savedGames = JSON.parse(localStorage.getItem('darts_game_data') || '[]');
                
                // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒæ¯”è³½çš„è³‡æ–™
                const existingIndex = savedGames.findIndex(game => game.gameId === gameData.gameId);
                
                if (existingIndex > -1) {
                    if (confirm('æ­¤æ¯”è³½å·²æœ‰ä¿å­˜è³‡æ–™ï¼Œæ˜¯å¦è¦†è“‹ï¼Ÿ')) {
                        savedGames[existingIndex] = gameData;
                    } else {
                        return;
                    }
                } else {
                    savedGames.push(gameData);
                }
                
                localStorage.setItem('darts_game_data', JSON.stringify(savedGames));
                markAsSaved();
                alert('æ¯”è³½è³‡æ–™å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å„²ï¼\n\né é¢å°‡è‡ªå‹•é—œé–‰...');
                
                console.log('ä¿å­˜çš„è³‡æ–™ï¼š', gameData);
                
                // å»¶é² 1 ç§’å¾Œé—œé–‰åˆ†é 
                setTimeout(() => {
                    window.close();
                }, 1000);
                
            } catch (error) {
                console.error('ä¿å­˜å¤±æ•—ï¼š', error);
                alert('ä¿å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨å­˜å„²æ¬Šé™');
            }
        }

        // ç”ŸæˆéŠæˆ²ä½ˆå±€
        function generateGameLayout() {
            const container = document.getElementById('gameRows');
            container.innerHTML = '';

            for (let i = 1; i <= 16; i++) {
                const row = document.createElement('div');
                row.className = 'game-row';
                
                row.innerHTML = `
                    <!-- SETç·¨è™Ÿ -->
                    <div class="set-number">SET${i}</div>
                    
                    <!-- ä¸»å ´é¸æ‰‹æŒ‰éˆ• -->
                    <button class="team-button home-team" data-set="${i}" data-team="home" onclick="openPlayerModal(${i}, 'home')">
                        <div class="set-title" id="home-team-name">${currentGame.home}</div>
                        <div class="set-type">${setTypes[i]}</div>
                        <div class="player-info" id="home-set${i}-player">é»æ“Šé¸æ“‡é¸æ‰‹</div>
                    </button>
                    
                    <!-- å®¢å ´é¸æ‰‹æŒ‰éˆ• -->
                    <button class="team-button away-team" data-set="${i}" data-team="away" onclick="openPlayerModal(${i}, 'away')">
                        <div class="set-title" id="away-team-name">${currentGame.away}</div>
                        <div class="set-type">${setTypes[i]}</div>
                        <div class="player-info" id="away-set${i}-player">é»æ“Šé¸æ“‡é¸æ‰‹</div>
                    </button>
                    
                    <!-- å…ˆæ”»æŒ‰éˆ• -->
                    <button class="control-button" data-set="${i}" data-type="firstAttack" onclick="openControlModal(${i}, 'firstAttack')" id="attack-set${i}">
                        é¸æ“‡
                    </button>
                    
                    <!-- å‹è² æŒ‰éˆ• -->
                    <button class="control-button" data-set="${i}" data-type="winLose" onclick="openControlModal(${i}, 'winLose')" id="win-set${i}">
                        é¸æ“‡
                    </button>
                `;
                
                container.appendChild(row);
            }
        }

        // é–‹å•Ÿæ§åˆ¶é¸æ“‡å½ˆçª—ï¼ˆå…ˆæ”»/å‹è² ï¼‰
        function openControlModal(setNumber, type) {
            // å¦‚æœæ˜¯å‹è² é¸æ“‡ï¼Œå…ˆæª¢æŸ¥é¸æ‰‹æ˜¯å¦å·²å®Œæˆé¸æ“‡
            if (type === 'winLose') {
                const homeKey = `home-${setNumber}`;
                const awayKey = `away-${setNumber}`;
                const requiredPlayers = setPlayerCounts[setNumber];
                const homeCount = selectedPlayers[homeKey] ? selectedPlayers[homeKey].length : 0;
                const awayCount = selectedPlayers[awayKey] ? selectedPlayers[awayKey].length : 0;
                
                if (homeCount !== requiredPlayers || awayCount !== requiredPlayers) {
                    let missingTeams = [];
                    if (homeCount !== requiredPlayers) {
                        missingTeams.push(`ä¸»å ´é¸æ‰‹ (${homeCount}/${requiredPlayers})`);
                    }
                    if (awayCount !== requiredPlayers) {
                        missingTeams.push(`å®¢å ´é¸æ‰‹ (${awayCount}/${requiredPlayers})`);
                    }
                    
                    alert(`âŒ ç„¡æ³•é¸æ“‡å‹è² ï¼\n\nSET${setNumber} è«‹å…ˆå®Œæˆé¸æ‰‹ç™»è¨˜ï¼š\n${missingTeams.join('\n')}\n\nè«‹å…ˆé¸æ»¿æ‰€éœ€é¸æ‰‹æ•¸é‡å¾Œå†é€²è¡Œå‹è² é¸æ“‡ã€‚`);
                    return;
                }
            }
            
            currentSet = setNumber;
            currentControlType = type;
            
            const title = type === 'firstAttack' ? 'é¸æ“‡å…ˆæ”»' : 'é¸æ“‡å‹è² ';
            const currentSelection = type === 'firstAttack' ? firstAttackData[setNumber] : winLoseData[setNumber];
            
            document.getElementById('controlModalTitle').textContent = title;
            document.getElementById('controlModalSubtitle').textContent = `SET${setNumber}`;
            
            // æ›´æ–°é¸é …æ–‡å­—
            if (type === 'firstAttack') {
                document.getElementById('controlHomeOption').textContent = 'ä¸»';
                document.getElementById('controlAwayOption').textContent = 'å®¢';
            } else {
                document.getElementById('controlHomeOption').textContent = 'ä¸»';
                document.getElementById('controlAwayOption').textContent = 'å®¢';
            }
            
            // æ¸…é™¤æ‰€æœ‰é¸ä¸­ç‹€æ…‹
            document.querySelectorAll('#controlModal .player-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // è¨­å®šç•¶å‰é¸ä¸­ç‹€æ…‹
            if (currentSelection === 'home') {
                document.getElementById('controlHomeOption').classList.add('selected');
            } else if (currentSelection === 'away') {
                document.getElementById('controlAwayOption').classList.add('selected');
            } else {
                document.getElementById('controlNullOption').classList.add('selected');
            }
            
            document.getElementById('controlModal').style.display = 'block';
        }

        // é¸æ“‡æ§åˆ¶é¸é …
        function selectControl(choice) {
            // æ¸…é™¤æ‰€æœ‰é¸ä¸­ç‹€æ…‹
            document.querySelectorAll('#controlModal .player-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // è¨­å®šæ–°çš„é¸ä¸­ç‹€æ…‹
            if (choice === 'home') {
                document.getElementById('controlHomeOption').classList.add('selected');
            } else if (choice === 'away') {
                document.getElementById('controlAwayOption').classList.add('selected');
            } else {
                document.getElementById('controlNullOption').classList.add('selected');
            }
            
            // æ›´æ–°æ•¸æ“š
            if (currentControlType === 'firstAttack') {
                firstAttackData[currentSet] = choice;
            } else {
                winLoseData[currentSet] = choice;
            }
            
            // æ›´æ–°æŒ‰éˆ•é¡¯ç¤º
            updateControlButton(currentSet, currentControlType, choice);
            
            // æ¨™è¨˜æœ‰è®Šæ›´
            markAsChanged();
            
            // æ›´æ–°è©¦ç®—
            updateScoreCalculation();
            
            // ç«‹å³é—œé–‰å½ˆçª—
            closeControlModal();
        }

        // æ›´æ–°æ§åˆ¶æŒ‰éˆ•é¡¯ç¤º
        function updateControlButton(setNumber, type, choice) {
            const button = document.getElementById(`${type === 'firstAttack' ? 'attack' : 'win'}-set${setNumber}`);
            
            // æ¸…é™¤æ‰€æœ‰é¸æ“‡ç‹€æ…‹
            button.classList.remove('home-selected', 'away-selected');
            
            if (choice) {
                const displayText = choice === 'home' ? 'ä¸»' : 'å®¢';
                button.classList.add(choice === 'home' ? 'home-selected' : 'away-selected');
                
                if (type === 'firstAttack') {
                    button.textContent = `${displayText} å…ˆæ”»`;
                } else {
                    button.textContent = `${displayText} å‹`;
                }
            } else {
                button.textContent = 'é¸æ“‡';
            }
        }

        // é—œé–‰æ§åˆ¶é¸æ“‡å½ˆçª—
        function closeControlModal() {
            document.getElementById('controlModal').style.display = 'none';
        }

        // é—œé–‰é¸æ‰‹é¸æ“‡å½ˆçª—
        function closePlayerModal() {
            document.getElementById('playerModal').style.display = 'none';
        }

        // é»æ“Šå½ˆçª—å¤–éƒ¨é—œé–‰
        document.getElementById('playerModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closePlayerModal();
            }
        });

        document.getElementById('controlModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeControlModal();
            }
        });

        // ç€è¦½å™¨é›¢é–‹é é¢è­¦å‘Š
        window.addEventListener('beforeunload', function(e) {
            if (hasAnyData() && hasUnsavedChanges) {
                e.preventDefault();
                e.returnValue = 'æ‚¨æœ‰æœªä¿å­˜çš„æ¯”è³½è³‡æ–™ï¼Œç¢ºå®šè¦é›¢é–‹å—ï¼Ÿ';
                return 'æ‚¨æœ‰æœªä¿å­˜çš„æ¯”è³½è³‡æ–™ï¼Œç¢ºå®šè¦é›¢é–‹å—ï¼Ÿ';
            }
        });

        // é é¢å¯è¦‹æ€§è®ŠåŒ–è­¦å‘Šï¼ˆé©ç”¨æ–¼ç§»å‹•ç«¯ï¼‰
        document.addEventListener('visibilitychange', function() {
            if (document.hidden && hasAnyData() && hasUnsavedChanges) {
                // ç§»å‹•ç«¯å¯èƒ½ä¸æ”¯æ´ beforeunloadï¼Œé€™è£¡å¯ä»¥æ·»åŠ é¡å¤–è™•ç†
                console.log('é é¢éš±è—ï¼Œæœ‰æœªä¿å­˜çš„è³‡æ–™');
            }
        });
    </script>
</body>
</html> 